# Puppeteer 资源管理流程图

## 页面生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                    用户请求生成图片                          │
└───────────────────────┬─────────────────────────────────────┘
                        │
                        ▼
         ┌──────────────────────────────┐
         │  调用 createPage()            │
         └──────────┬───────────────────┘
                    │
                    ▼
         ┌──────────────────────────────┐
         │  检查页面池是否已满           │
         │  (当前数量 < maxPages=5?)    │
         └──────────┬───────────────────┘
                    │
         ┌──────────┴──────────┐
         │                     │
    已满 ▼                     ▼ 未满
┌─────────────────┐    ┌──────────────────┐
│ 等待100ms重试   │    │ 创建新页面        │
│ (自动排队)      │    └────────┬─────────┘
└────────┬────────┘             │
         │                      │
         └──────────────┬───────┘
                        │
                        ▼
         ┌──────────────────────────────┐
         │ 添加到页面池 (pagePool)       │
         │ 设置30秒超时定时器            │
         └──────────┬───────────────────┘
                    │
                    ▼
         ┌──────────────────────────────┐
         │      执行图片生成逻辑         │
         │   (try块中的业务代码)         │
         └──────────┬───────────────────┘
                    │
         ┌──────────┴──────────┐
         │                     │
    成功 ▼                     ▼ 异常
┌─────────────────┐    ┌──────────────────┐
│ 返回图片数据     │    │ 抛出错误          │
└────────┬────────┘    └────────┬─────────┘
         │                      │
         └──────────────┬───────┘
                        │
                        ▼
         ┌──────────────────────────────┐
         │      finally 块执行           │
         │ closePage(page) 确保清理      │
         └──────────┬───────────────────┘
                    │
                    ▼
         ┌──────────────────────────────┐
         │  清除超时定时器               │
         │  从页面池移除                 │
         │  关闭页面                     │
         └──────────┬───────────────────┘
                    │
                    ▼
         ┌──────────────────────────────┐
         │     页面生命周期结束          │
         └──────────────────────────────┘
```

## 自动清理机制

```
程序启动
    │
    ▼
┌─────────────────────────────────────┐
│  启动定期清理监控                    │
│  (每60秒执行一次)                   │
└──────────┬──────────────────────────┘
           │
           ▼
    ┌──────────────┐
    │  等待60秒    │◄─────────┐
    └──────┬───────┘          │
           │                  │
           ▼                  │
    ┌──────────────────────┐ │
    │ 获取浏览器所有页面    │ │
    └──────┬───────────────┘ │
           │                  │
           ▼                  │
    ┌──────────────────────┐ │
    │ 遍历每个页面          │ │
    │ 检查是否在页面池中    │ │
    └──────┬───────────────┘ │
           │                  │
           ▼                  │
    ┌──────────────────────┐ │
    │ 发现未追踪页面?       │ │
    └──────┬───────────────┘ │
           │                  │
    ┌──────┴──────┐          │
    │             │          │
否  ▼             ▼ 是       │
┌────────┐  ┌─────────────┐ │
│ 跳过   │  │ 关闭泄漏页面 │ │
└────────┘  │ (记录警告)   │ │
            └─────────────┘ │
                   │         │
                   └─────────┘
```

## 超时清理机制

```
创建页面
    │
    ▼
┌─────────────────────┐
│ 设置30秒定时器       │
└──────────┬──────────┘
           │
    ┌──────┴──────┐
    │             │
    ▼             ▼
正常关闭      等待30秒
    │             │
    ▼             ▼
┌─────────┐  ┌──────────────┐
│清除定时器│  │ 定时器触发    │
└─────────┘  │ 检查页面状态  │
             └──────┬───────┘
                    │
             ┌──────┴──────┐
             │             │
        已关闭▼             ▼未关闭
        ┌────────┐  ┌──────────────┐
        │ 忽略   │  │ 强制关闭页面  │
        └────────┘  │ (记录警告)    │
                    └───────────────┘
```

## 程序退出流程

```
收到退出信号
(SIGINT/SIGTERM)
    │
    ▼
┌─────────────────────┐
│ gracefulShutdown()  │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 停止定期清理监控     │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 遍历页面池          │
│ 逐个关闭所有页面    │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 关闭浏览器实例       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│ 关闭WebSocket       │
└──────────┬──────────┘
           │
           ▼
┌─────────────────────┐
│   程序安全退出       │
└─────────────────────┘
```

## 并发控制示意

```
时间轴 →

请求1  ━━━━━━━━━━━━━━━━━━━━━━━━ [页面1生成] ━━━━━━ 完成
请求2    ━━━━━━━━━━━━━━━━ [页面2生成] ━━━━━━━━ 完成
请求3      ━━━━━━━ [页面3生成] ━━━━━━━━━━━━━━ 完成
请求4        ━━━━━━━━━ [页面4生成] ━━━━━━━━ 完成
请求5          ━━━━ [页面5生成] ━━━━━━━━━━ 完成
请求6            ⏸️等待⏸️  [页面6生成] ━━━━ 完成  ← 等待页面1释放
请求7              ⏸️等待⏸️  [页面7生成] ━━ 完成  ← 等待页面2释放

页面池:  [1][2][3][4][5]  最多5个
         └─释放→ [6]      ← 请求6获得空位
               └─释放→ [7] ← 请求7获得空位
```

## 资源状态监控

```
┌─────────────────────────────────────────────┐
│          页面池状态监控                      │
├─────────────────────────────────────────────┤
│  活跃页面: ████████░░  4/5                  │
│  可用槽位: ██░░░░░░░░  1                    │
│                                             │
│  最近事件:                                  │
│  ✓ 页面创建 (2 秒前)                        │
│  ✓ 页面关闭 (5 秒前)                        │
│  ⚠ 页面池满 (1 分钟前)                      │
│  ✓ 定期清理完成 (30 秒前)                   │
└─────────────────────────────────────────────┘

调用 getPoolStats() 获取:
{
  active: 4,      // 活跃页面数
  max: 5,         // 最大页面数
  available: 1    // 可用槽位
}
```

## 关键数据结构

```javascript
BrowserManager {
  browser: Browser实例           // Puppeteer浏览器
  pagePool: Set<Page>            // 页面集合
  ┌──────┬──────┬──────┬──────┐
  │ Page1│ Page2│ Page3│ Page4│  ← 当前活跃页面
  └──────┴──────┴──────┴──────┘

  pageTimeouts: Map<Page, TimerId>  // 超时定时器映射
  ┌────────┬──────────┐
  │ Page1  │ Timer1   │
  │ Page2  │ Timer2   │
  │ Page3  │ Timer3   │
  │ Page4  │ Timer4   │
  └────────┴──────────┘

  maxPages: 5                    // 配置参数
  pageTimeout: 30000             // 30秒
  cleanupInterval: IntervalId    // 清理定时器
}
```
